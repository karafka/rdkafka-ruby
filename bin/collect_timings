#!/usr/bin/env bash

# Collects timing data from RSpec runs.
# Results are stored in spec/timings/specs.json for use by bin/balance_specs.
#
# Usage: bin/collect_timings

set -e

TIMINGS_DIR="spec/timings"
JSON_FILE="$TIMINGS_DIR/specs.json"
TMP_FILE="/tmp/rspec_results_$$.json"

mkdir -p "$TIMINGS_DIR"

echo "=== Collecting Spec Timings ==="
echo ""
echo "Running all specs with JSON output..."

# Run lib specs only (integration specs are excluded from parallel runs)
RUBYOPT="-W0" CI=true bundle exec rspec --pattern 'spec/lib/**/*_spec.rb' --format progress --format json --out "$TMP_FILE"

echo ""
echo "Parsing timing data..."

# Extract timing per file using ruby one-liner
ruby -rjson -e '
  data = JSON.parse(File.read(ARGV[0]))
  timings = Hash.new(0)
  data["examples"].each { |ex| timings[ex["file_path"]] += ex["run_time"] || 0 }
  sorted = timings.transform_values { |v| v.round(3) }.sort_by { |_, t| -t }.to_h
  puts JSON.pretty_generate(sorted)
' "$TMP_FILE" > "$JSON_FILE"

rm -f "$TMP_FILE"

echo "Saved $JSON_FILE"
echo ""
echo "Done!"
