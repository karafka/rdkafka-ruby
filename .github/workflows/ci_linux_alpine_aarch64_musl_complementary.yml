# CI Strategy: Complementary Testing for SSL and System Library Regressions on Alpine/musl ARM64
#
# This workflow runs complementary tests that don't need to block PRs but are essential
# for catching regressions in SSL functionality and musl libc/Alpine system library compatibility
# on ARM64 architecture.
#
# WHY COMPLEMENTARY TESTING FOR ALPINE/MUSL ARM64:
# - SSL specs have been stable for 3+ years and rarely break due to code changes
# - Integration specs test musl libc and Alpine package compatibility on ARM64
# - These tests catch regressions from external changes (OpenSSL updates, Alpine package updates)
# - Running every 3 days to prevent these slower tests from blocking PR velocity
# - Manual triggering allows testing workflow changes before they go into schedule
# - ARM64 emulation adds overhead, making these tests slower than native x86_64
#
# SSL TESTING (specs_install + specs_precompiled):
# - Tests SSL/TLS connectivity with Kafka using docker-compose-ssl.yml on Alpine ARM64
# - Validates certificate handling and SSL handshakes across Ruby versions on musl ARM64
# - Ensures SSL works with both compiled-from-source and precompiled flows on Alpine ARM64
# - Catches OpenSSL version compatibility issues and SSL library regressions on musl ARM64
# - Tests real SSL scenarios that mirror Alpine ARM64-based production deployments
#
# INTEGRATION TESTING (integration specs in both jobs):
# - Tests musl libc and Alpine system library compatibility on ARM64 without requiring Kafka infrastructure
# - Validates libssl, libsasl2, libzstd, zlib integration across Alpine versions on ARM64
# - Ensures native extensions work with different Alpine package versions on ARM64
# - Catches regressions from Alpine package updates and musl libc changes on ARM64
# - Tests both compilation and precompiled library compatibility on Alpine ARM64
#
# SCHEDULING STRATEGY:
# - Runs every 3 days at 6 AM to catch system/library changes from Alpine base image updates
# - Triggers on workflow file changes to validate CI modifications
# - Manual dispatch available for ad-hoc regression testing
# - Separate artifact naming prevents interference with main CI
#
# This approach ensures comprehensive coverage while keeping PR CI fast and focused
# on code-related issues rather than infrastructure/system regressions on Alpine ARM64.

name: CI Linux Complementary Alpine aarch64 musl

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  schedule:
    - cron: '0 6 */3 * *'
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/ci_linux_alpine_aarch64_musl_complementary.yml'
      - 'spec/integrations/**'
    branches: [ master ]
  push:
    branches:
      - 'v[0-9]+.[0-9]+.*'
    tags-ignore:
      - '**'

permissions:
  contents: read

env:
  BUNDLE_RETRY: 6
  BUNDLE_JOBS: 4

jobs:
  build_precompiled:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Set up QEMU for ARM64 emulation
        uses: docker/setup-qemu-action@49b3bc8e6bdd4a60e6116a5414239cba5943d3cf # v3.2.0
        with:
          platforms: linux/arm64

      - name: Build precompiled librdkafka.so in Alpine ARM64 container
        run: |
          docker run --rm --platform linux/arm64 \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            alpine:3.23@sha256:865b95f46d98cf867a156fe4a135ad3fe50d2056aa3f25ed31662dff6da4eb62 \
            sh -c '
              apk add --no-cache git curl ca-certificates build-base linux-headers \
                pkgconf perl autoconf automake libtool bison flex file bash wget zstd-dev \
                openssl-dev cyrus-sasl-dev cyrus-sasl cyrus-sasl-login \
                cyrus-sasl-crammd5 cyrus-sasl-digestmd5 cyrus-sasl-gssapiv2 cyrus-sasl-scram \
                krb5-libs openssl zlib zlib-dev zstd-libs && \
              git config --global --add safe.directory /workspace && \
              cd /workspace/ext && \
              bash ./build_linux_aarch64_musl.sh
            '

      - name: Upload precompiled library
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: librdkafka-precompiled-aarch64-musl-complementary
          path: ext/
          retention-days: 1

  specs_install:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - ruby: '3.4'
            alpine_version: '3.22'
          - ruby: '3.3'
            alpine_version: '3.21'
          - ruby: '3.2'
            alpine_version: '3.21'
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Set up QEMU for ARM64 emulation
        uses: docker/setup-qemu-action@49b3bc8e6bdd4a60e6116a5414239cba5943d3cf # v3.2.0
        with:
          platforms: linux/arm64

      - name: Start Kafka with Docker Compose
        run: |
          ./ext/generate-ssl-certs.sh
          docker compose -f docker-compose-ssl.yml up -d
          echo "Waiting for Kafka to be ready..."
          sleep 10
          for i in {1..30}; do
            if docker compose exec -T kafka kafka-topics --bootstrap-server localhost:9092 --list >/dev/null 2>&1; then
              echo "Kafka topics command succeeded!"
              break
            fi
            sleep 2
          done

      - name: Run all specs in SSL (compiled flow)
        env:
          KAFKA_SSL_ENABLED: "true"
        run: |
          docker run --rm --platform linux/arm64 \
            --network host \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            -e "KAFKA_SSL_ENABLED=true" \
            ruby:${{ matrix.ruby }}-alpine${{ matrix.alpine_version }} \
            sh -c 'apk add --no-cache git curl ca-certificates build-base linux-headers \
              pkgconf perl autoconf automake libtool bison flex file \
              ruby-dev ruby-bundler bash zstd-dev zlib zlib-dev openssl-dev \
              cyrus-sasl-dev cyrus-sasl cyrus-sasl-login \
              cyrus-sasl-crammd5 cyrus-sasl-digestmd5 cyrus-sasl-gssapiv2 cyrus-sasl-scram \
              krb5-libs openssl zlib zstd-libs openjdk17-jre-headless && \
              git config --global --add safe.directory /workspace && \
              bundle config set --local path vendor/bundle && \
              bundle install && \
              cd ext && bundle exec rake && \
              cd .. && \
              echo "=== SSL Library Versions ===" && \
              openssl version && \
              apk list --installed | grep -E "(openssl|cyrus-sasl)" && \
              echo "=== Running SSL Specs (Compiled) ===" && \
              bundle exec ruby -S rspec'

      - name: Verify Kafka warnings
        run: bin/verify_kafka_warnings

      - name: Run integration specs (compiled flow)
        run: |
          docker run --rm --platform linux/arm64 \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            ruby:${{ matrix.ruby }}-alpine${{ matrix.alpine_version }} \
            sh -c 'apk add --no-cache git curl ca-certificates build-base linux-headers \
              pkgconf perl autoconf automake libtool bison flex file \
              ruby-dev ruby-bundler bash zstd-dev zlib zlib-dev openssl-dev \
              cyrus-sasl-dev cyrus-sasl cyrus-sasl-login \
              cyrus-sasl-crammd5 cyrus-sasl-digestmd5 cyrus-sasl-gssapiv2 cyrus-sasl-scram \
              krb5-libs openssl zlib zstd-libs libcurl curl-dev && \
              git config --global --add safe.directory /workspace && \
              bundle config set --local path vendor/bundle && \
              bundle install && \
              cd ext && bundle exec rake && \
              cd .. && \
              echo "=== Alpine/musl Library Versions ===" && \
              openssl version && \
              apk list --installed | grep -E "(openssl|cyrus-sasl|zstd|zlib)" && \
              echo "=== Running Integration Specs (Compiled) ===" && \
              for file in $(ls spec/integrations/*_spec.rb); do \
                echo "Running $file with Ruby ${{ matrix.ruby }} on Alpine ${{ matrix.alpine_version }} ARM64"; \
                bundle exec ruby "$file" || exit 1; \
              done'

  specs_precompiled:
    timeout-minutes: 45
    needs: build_precompiled
    strategy:
      fail-fast: false
      matrix:
        ruby:
          - '3.4'
          - '3.3'
          - '3.2'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Download precompiled library
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: librdkafka-precompiled-aarch64-musl-complementary
          path: ext/

      - name: Set up QEMU for ARM64 emulation
        uses: docker/setup-qemu-action@49b3bc8e6bdd4a60e6116a5414239cba5943d3cf # v3.2.0
        with:
          platforms: linux/arm64

      - name: Start Kafka with Docker Compose
        run: |
          ./ext/generate-ssl-certs.sh
          docker compose -f docker-compose-ssl.yml up -d
          echo "Waiting for Kafka to be ready..."
          sleep 10

          for i in {1..30}; do
            if docker compose exec -T kafka kafka-topics --bootstrap-server localhost:9092 --list >/dev/null 2>&1; then
              echo "Kafka topics command succeeded!"
              break
            fi
            sleep 2
          done

      - name: Run specs with precompiled library and SSL
        env:
          RDKAFKA_EXT_PATH: ${{ github.workspace }}/ext
          KAFKA_SSL_ENABLED: "true"
          RDKAFKA_PRECOMPILED: "true"
        run: |
          docker run --rm --platform linux/arm64 \
            --network host \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            -e "RDKAFKA_EXT_PATH=/workspace/ext" \
            -e "KAFKA_SSL_ENABLED=true" \
            -e "RDKAFKA_PRECOMPILED=true" \
            ruby:${{ matrix.ruby }}-alpine \
            sh -c 'apk add --no-cache git build-base linux-headers bash openjdk17-jre-headless && \
              git config --global --add safe.directory /workspace && \
              bundle config set --local path vendor/bundle && bundle install && \
              apk list --installed | grep -E "(openssl|cyrus-sasl)" && \
              bundle exec ruby -S rspec'

      - name: Verify Kafka warnings
        run: bin/verify_kafka_warnings

      - name: Run integration specs (precompiled flow)
        env:
          RDKAFKA_EXT_PATH: ${{ github.workspace }}/ext
          RDKAFKA_PRECOMPILED: "true"
        run: |
          docker run --rm --platform linux/arm64 \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            -e "RDKAFKA_EXT_PATH=/workspace/ext" \
            -e "RDKAFKA_PRECOMPILED=true" \
            ruby:${{ matrix.ruby }}-alpine \
            sh -c 'apk add --no-cache git curl ca-certificates build-base linux-headers \
              pkgconf perl autoconf automake libtool bison flex file \
              ruby-dev ruby-bundler bash zstd-dev zlib zlib-dev openssl-dev \
              cyrus-sasl-dev cyrus-sasl cyrus-sasl-login \
              cyrus-sasl-crammd5 cyrus-sasl-digestmd5 cyrus-sasl-gssapiv2 cyrus-sasl-scram \
              krb5-libs openssl zlib zstd-libs libcurl curl-dev && \
              git config --global --add safe.directory /workspace && \
              bundle config set --local path vendor/bundle && \
              bundle install && \
              apk list --installed | grep -E "(openssl|cyrus-sasl|zstd|zlib)" && \
              echo "=== Running Integration Specs (Precompiled) ===" && \
              for file in $(ls spec/integrations/*_spec.rb); do \
                echo "Running $file with Ruby ${{ matrix.ruby }} (precompiled ARM64)"; \
                bundle exec ruby "$file" || exit 1; \
              done'

  ci-success:
    name: CI Linux Complementary Alpine aarch64 musl Success
    runs-on: ubuntu-latest
    if: always()
    needs:
      - specs_install
      - build_precompiled
      - specs_precompiled
    steps:
      - name: Check all jobs passed
        if: |
          contains(needs.*.result, 'failure') ||
          contains(needs.*.result, 'cancelled') ||
          contains(needs.*.result, 'skipped')
        run: exit 1
      - run: echo "All CI checks passed!"
